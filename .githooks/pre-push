
#!/usr/bin/env bash
set -euo pipefail

echo "[pre-push] Building production site into docs/"

# Run the build (Vite configured to output to docs/). If this fails we must abort the push.
if ! npm run build; then
  echo "[pre-push] Build failed — aborting push. Fix build errors and try again."
  exit 1
fi

echo "[pre-push] Build finished. Checking for changes in docs/..."

# If there are changes in docs/, stage them and create a build commit. Do not abort if commit fails.
if [[ -n "$(git status --porcelain docs)" ]]; then
  echo "[pre-push] Detected changes in docs/. Creating commit"
  git add docs
  git commit -m "chore(build): update docs (pre-push)" --no-verify || {
    echo "[pre-push] Commit failed — aborting push."
    exit 1
  }
else
  echo "[pre-push] No changes to docs/"
fi

echo "[pre-push] Build succeeded — continuing with push."
exit 0
